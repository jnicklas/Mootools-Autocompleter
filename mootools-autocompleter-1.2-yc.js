/**
 * Mootools Autocompleter
 * 
 * Copyright (c) 2011, Weeby
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *  - Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 *  - Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *  - Neither the name of the Weeby nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * @version 1.2
 * @category visual
 * @package mootools
 * @subpakage ui.autocompleter
 * @author Tomasz WÃ³jcik (t.wojcik@weeby.pl)
 */

var Autocompleter=new Class({_defaults:{id:null,className:"mui-autocompleter",delay:300,minLength:3,allowNewValues:false,onCreate:function(){},onSearch:function(){},onSuggest:function(){},onChange:function(){},onBeforeShow:function(){}},initialize:function(d,b){b=$merge(this._defaults,b);if(b.id==null){var c=d.get("id");if(c==null){c=d.get("name").replace("_","-").camelCase()}b.id="Autocompleter-"+c}this.wrapper=new Element("div",{id:b.id,"class":b.className,html:'<div style="display: none;" class="'+b.className+'-menu"><ul></ul></div>'});this.element=d;var a="";if(this.element.get("data-autocompleter-default")!=null){a=this.element.get("data-autocompleter-default")}this.hiddenInput=new Element("input",{type:"hidden",name:this.element.get("name"),value:a});this.element.erase("name").addClass(b.className+"-input").set("autocomplete","off");this.hiddenInput.inject(this.element,"after");this.wrapper.inject(document.getElement("body"));this.options=b;this.selectors={menuWrapper:"div."+b.className+"-menu"};this.timeout=null;this.lastFilter=null;this._addEvents()},_input:function(){return this.element.getNext("input['hidden']")},_onInputKeyDown:function(a){if((a.control==true)||(a.meta==true)){return true}var b=function(e,f){var d=["left","right","tab"];var g=[33,34,35,36];if((d.indexOf(e)!=-1)||(g.indexOf(f)!=-1)){return true}return false};var c=false;if(a.key=="esc"){this._handleNewValue();this._hideMenu()}else{if(a.key=="up"){this._moveActive("up")}else{if(a.key=="down"){this._moveActive("down")}else{if(a.key=="enter"){this._chooseItem()}else{if(b(a.key,a.code)){c=true}else{c=true;if(this.timeout!=null){window.clearTimeout(this.timeout)}this.timeout=window.setTimeout(this._onInputChange.bind(this),this.options.delay)}}}}}if(c==false){a.stop()}return c},_onInputChange:function(c,b){var a=b||this.element.get("value");this._input().set("value","");if(a.length>=this.options.minLength){this.lastFilter=a;var d=[];this._fireEvent("onSearch",this.element);if(this.options.source!=null){d=this.options.source(this.element,a)}this.suggest(d)}else{this.lastFilter=a;this._handleNewValue();this._hideMenu()}},_handleNewValue:function(a){a=(a==null)?true:a;if(this._input().get("value")==""){if(this.options.allowNewValues==true){this._input().set("value",this.element.get("value"))}else{this._input().set("value","")}this._input().store("itemdata",null);if(a==true){this._fireEvent("onChange",this.element)}}},_onInputBlur:function(){if(this.options.allowNewValues==true){this._handleNewValue()}this._hideMenu();return true},_onMenuItemMousedown:function(b){b.stop();var a=$(b.target);if(a.get("tag")!="li"){a=a.getParent("li")}this._chooseItem(a)},_chooseItem:function(b){var a=null;if(b==null){a=this.wrapper.getElement("li.active")}else{a=$(b)}if(a!=null){this.element.set("value",a.retrieve("label"));this._input().set("value",a.retrieve("value"));this._input().store("itemdata",a.retrieve("itemdata",null));a.removeClass("active")}else{this._handleNewValue(false)}this._fireEvent("onChange",this.element);this._hideMenu()},_fireEvent:function(){var c=Array.clone(arguments);var b=c.shift();var a=this.options[b];if(a!=null){a=a.pass(c);return a()}return false},_created:function(){this._fireEvent("onCreate",this.element)},_showMenu:function(){var a=this.wrapper.getElement(this.selectors.menuWrapper);this._fireEvent("onBeforeShow",this.element);a.setStyle("display","block");a.scrollTo(0,0);document.addEvent("mousedown",this._onInputBlur.bind(this))},_hideMenu:function(){this.wrapper.getElement(this.selectors.menuWrapper).setStyle("display","none");document.removeEvent("mousedown",this._onInputBlur.bind(this))},_moveActive:function(h){h=h||"up";var e=null;var b=this.wrapper.getElement("li.active");if(b==null){e=this.wrapper.getElement("li")}else{if(h=="up"){e=b.getPrevious("li")}else{e=b.getNext("li")}}if(e!=null){if(b!=null){b.removeClass("active")}e.addClass("active");var g=this.wrapper.getElement(this.selectors.menuWrapper);var d=g.getElement("ul");if(d.getSize().y>g.getSize().y){var i=e.getPosition(this.selectors.menuWrapper).y-g.getPosition().y;var c=g.getScroll().y;var f=g.getSize().y;var a=e.getSize().y;g.scrollTo(0,c+i-f+a)}}},_populateMenu:function(a){var c=this.wrapper.getElement("ul");c.empty();this.wrapper.getElement(this.selectors.menuWrapper).scrollTo(0);if(a.length==0){return}var b=null;Array.each(a,function(e,d){b=new Element("li");if(e.html==null){b.set("html",e.label)}else{b.set("html",e.html)}b.store("label",e.label);b.store("value",e.value);if(typeOf(e.data)!="null"){b.store("itemdata",e.data)}b.inject(c)});if(a.length==1){c.getElement("li").addClass("active")}c.getElements("li").addEvent("mousedown",this._onMenuItemMousedown.bind(this))},_addEvents:function(){this.element.addEvent("keydown",this._onInputKeyDown.bind(this));this.wrapper.getElement(this.selectors.menuWrapper).addEvent("mousedown",function(a){a.stop()})},_call:function(){var a=arguments[0];if((a=="initialize")||(a[0]=="_")){return null}a=this[a];if(typeof(a)=="function"){var b=Array.clone(arguments);b.shift();a=a.pass(b,this);return a()}else{return null}},value:function(){return this._input().get("value")},data:function(){return this._input().retrieve("itemdata",null)},suggest:function(a){if(a instanceof Array==false){return false}this._fireEvent("onSuggest",this.element);this._populateMenu(a);if(a.length==0){this._handleNewValue();this._hideMenu()}else{this._showMenu()}return true},option:function(a,b){if(b==null){return this.options[a]}else{this.options[a]=b;return null}},menu:function(){return this.wrapper}});if(typeof(Array.clone)=="undefined"){Array.clone=function(b){var a=[];Array.each(b,function(d,c){a[c]=d});return a}}if(typeof(typeOf)=="undefined"){typeOf=function(b){var a=$type(b);if(a==false){return"null"}else{return a}}}Element.implement({autocompleter:function(){if(arguments.length==0){return this}var b=arguments[0];if(typeof(b)=="object"){var c=new Autocompleter(this,b);this.store("ui.autocompleter",c);c._created()}else{var c=this.retrieve("ui.autocompleter",null);if(c!=null){var a=c._call.pass(arguments,c);return a()}}return this}});